<!DOCTYPE html>
<html>
  <head>
    <title>Email Sender</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Email Sender</h1>

    <button onclick="mail(0)">Simple Email</button>
    <button onclick="mail(1)">Mass email</button>

    <form id="emailForm">
      <label for="to">To:</label>
      <input
        type="text"
        id="to"
        name="to"
        placeholder="Enter email addresses (comma-separated)"
        required
      />

      <label for="subject">Subject:</label>
      <input
        type="text"
        id="subject"
        name="subject"
        placeholder="Enter email subject"
        required
      />

      <label for="message">Message:</label>
      <textarea id="message" name="message" rows="4" required></textarea>

      <input type="submit" value="Send Emails" />
    </form>

    <form id="emailFormCSV">
      <label for="csvFile">Upload CSV File:</label>
      <input type="file" id="csvFile" name="file" />

      <label for="subject">Subject:</label>
      <input
        type="text"
        id="CSVsubject"
        name="subject"
        placeholder="Enter email subject"
        required
      />

      <label for="message">Message:</label>
      <textarea id="CSVmessage" name="message" rows="4" required></textarea>

      <input type="submit" value="Send Emails" />
    </form>

    <script>
      var form1 = document.getElementById("emailForm");
      var form2 = document.getElementById("emailFormCSV");
      var option = 0;
      form2.style.display = "none";

      // Function to handle form submission
      function handleFormSubmit(event) {
        event.preventDefault();
        if (option == 0) {
          // Prevent the default form submission
          const to = document.getElementById("to").value;
          const subject = document.getElementById("subject").value;
          const message = document.getElementById("message").value;
          const data = {
            to: to,
            subject: subject,
            message: message,
          };
          // Send the data to the server (replace 'http://your-backend-url:port/send-emails' with the actual URL)
          fetch("http://127.0.0.1:5000/send-emails", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.ok) {
                alert("Emails sent successfully!");
              } else {
                alert("Failed to send emails. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        } else {
          const fileInput = document.getElementById("csvFile");
          const selectedFile = fileInput.files[0];
          
          if (!selectedFile) {
            alert("Please select a CSV file.");
            return;
          }

          const reader = new FileReader();
          const emailAddresses = [];

          reader.onload = function (event) {
            const csvData = event.target.result;
            const lines = csvData.split("\n");
            const headers = lines[0].split(",");

            // Find the index of the 'Email' column
            const emailIndex = headers.findIndex(
              (header) => header.trim() === "Email"
            );

            if (emailIndex === -1) {
              alert('The "Email" column was not found in the CSV.');
              return;
            }

            for (let i = 1; i < lines.length; i++) {
              const columns = lines[i].split(",");
              if (columns.length > emailIndex) {
                emailAddresses.push(columns[emailIndex].trim());
              }
            }
            // Now you have the email addresses in the "Email" column
            console.log(emailAddresses);
          };

          reader.readAsText(selectedFile);
          const subject = document.getElementById("subject").value;
          const message = document.getElementById("message").value;
          const data = {
            to: emailAddresses,
            subject: subject,
            message: message,
          };
          // Send the data to the server (replace 'http://your-backend-url:port/send-emails' with the actual URL)
          fetch("http://127.0.0.1:5000/upload-csv", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.ok) {
                alert("Emails sent successfully!");
              } else {
                alert("Failed to send emails. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      }

      form1.addEventListener("submit", handleFormSubmit);
      form2.addEventListener("submit", handleFormSubmit);
      function mail(i) {
        console.log(i);
        option = i;
        if (i == 0) {
          form2.style.display = "none";
          form1.style.display = "block";
        } else {
          form2.style.display = "block";
          form1.style.display = "none";
        }
      }
    </script>
  </body>
</html>
